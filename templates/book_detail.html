{% extends "base.html" %}
{% load markdown_comments %}

{% block content %}

<!-- ì±… ì •ë³´ ë°•ìŠ¤ -->
<div class="bg-white shadow-md rounded-lg p-6 mb-8 grid grid-cols-1 md:grid-cols-3 gap-6">
  <!-- í‘œì§€ ì´ë¯¸ì§€ -->
  <div>
    {% if book.image %}
      <img src="{{ book.image.url }}" alt="Book Cover" class="w-full h-auto rounded shadow-md">
    {% else %}
      <div class="w-full h-48 bg-gray-200 flex items-center justify-center text-gray-500 rounded">
        í‘œì§€ ì—†ìŒ
      </div>
    {% endif %}
  </div>

  <!-- ì±… í…ìŠ¤íŠ¸ ì •ë³´ -->
  <div class="md:col-span-2">
    <h2 class="text-3xl font-bold text-gray-800 mb-2">{{ book.title }}</h2>
    <p class="text-gray-600 mb-1"><strong>ì €ì:</strong> {{ book.author }}</p>
    {% if book.category %}<p class="text-gray-600 mb-1"><strong>ì¹´í…Œê³ ë¦¬:</strong> {{ book.category }}</p>{% endif %}
    {% if book.published_date %}<p class="text-gray-600 mb-1"><strong>ì¶œíŒì¼:</strong> {{ book.published_date }}</p>{% endif %}
    {% if book.isbn %}<p class="text-gray-600 mb-1"><strong>ISBN:</strong> {{ book.isbn }}</p>{% endif %}
    <p class="text-gray-600 mb-1"><strong>ì¡°íšŒìˆ˜:</strong> {{ book.views }}</p>
    <p class="text-yellow-600 font-semibold mb-4"><strong>í‰ê·  ë³„ì :</strong> {{ avg_rating }}ì </p>

    {% if book.description %}
      <div class="mt-4">
        <h4 class="font-semibold text-gray-700 mb-1">ğŸ“– ì±… ì†Œê°œ</h4>
        <p class="text-sm text-gray-800 whitespace-pre-line">{{ book.description }}</p>
      </div>
    {% endif %}

    <!-- ğŸ“˜ ëŒ€ì¶œ ìƒíƒœ -->
    <div class="mt-6">
      <p class="text-sm font-semibold text-gray-700">ğŸ“š ìƒíƒœ: 
        {% if is_borrowed %}
          <span class="text-red-600">ëŒ€ì¶œ ì¤‘</span>
        {% else %}
          <span class="text-green-600">ëŒ€ì¶œ ê°€ëŠ¥</span>
        {% endif %}
      </p>
    </div>

    <!-- ğŸ“Œ ëŒ€ì¶œ / ë°˜ë‚© / ê¸°ë¡ ë²„íŠ¼ -->
    <div class="mt-4 flex gap-3 flex-wrap">
      {% if user.is_authenticated %}
        {% if not is_borrowed %}
          <form method="post" action="{% url 'common:borrow_book' book.id %}">
            {% csrf_token %}
            <button type="submit" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded">
              ëŒ€ì¶œ
            </button>
          </form>
        {% elif is_borrowed_by_user %}
          <form method="post" action="{% url 'common:return_book' book.id %}">
            {% csrf_token %}
            <button type="submit" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded">
              ë°˜ë‚©
            </button>
          </form>
        {% endif %}
        <a href="{% url 'common:borrow_history' book.id %}" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded inline-block">
          ëŒ€ì¶œ ê¸°ë¡ ë³´ê¸°
        </a>
      {% else %}
        <p class="text-sm text-gray-500 mt-2">ë¡œê·¸ì¸ í›„ ëŒ€ì¶œ/ë°˜ë‚© ê¸°ëŠ¥ì„ ì´ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
      {% endif %}
    </div>

    <!-- ë³„ì  í¼ -->
    <div class="mt-6">
      {% if user.is_authenticated %}
        {% if not user_rating %}
          <form method="post" class="mb-4">
            {% csrf_token %}
            <label class="block mb-2 font-medium text-gray-700">{{ rating_form.score.label }}</label>
            {{ rating_form.score }}
            <button type="submit" class="bg-yellow-400 hover:bg-yellow-500 text-white px-4 py-1 rounded mt-2">
              ë³„ì  ë‚¨ê¸°ê¸°
            </button>
          </form>
        {% else %}
          <p class="text-green-600"><strong>ë‹¹ì‹ ì˜ í‰ê°€:</strong> {{ user_rating.score }}ì </p>
        {% endif %}
      {% else %}
        <p class="text-sm text-gray-500 mt-2">
          <a href="{% url 'common:login' %}" class="text-blue-600 underline">ë¡œê·¸ì¸</a> í›„ ë³„ì ì„ ì¤„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
        </p>
      {% endif %}
    </div>
  </div>
</div>

<!-- ëŒ“ê¸€ ì˜ì—­ -->
<div class="bg-white shadow rounded-lg p-6">
  <h3 class="text-xl font-bold mb-4">ğŸ’¬ ëŒ“ê¸€ ê²Œì‹œíŒ</h3>

  {% if user.is_authenticated %}
    <form method="post" class="mb-6">
      {% csrf_token %}
      {{ form.as_p }}
      <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">ëŒ“ê¸€ ë“±ë¡</button>
    </form>
  {% else %}
    <p class="text-sm text-gray-500 mb-4">
      <a href="{% url 'common:login' %}" class="text-blue-600 underline">ë¡œê·¸ì¸</a> í›„ ëŒ“ê¸€ì„ ì‘ì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
    </p>
  {% endif %}

  {% for comment in comments %}
    <div class="border-t pt-4 mt-4">
      <p class="text-sm text-gray-700 mb-1">
        <strong>{{ comment.user.username }}</strong>
        <span class="text-gray-400">({{ comment.created_at|date:"Y-m-d H:i" }})</span>
      </p>
      <div class="text-sm text-gray-800 leading-relaxed whitespace-pre-line">
        {{ comment.content|markdownify }}
      </div>
    </div>
  {% empty %}
    <p class="text-gray-500 mt-2">ì•„ì§ ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</p>
  {% endfor %}
</div>


<!-- ëª©ë¡ìœ¼ë¡œ -->
<div class="mt-6">
  <a href="{% url 'common:book_list' %}" class="text-blue-600 hover:underline">â† ì±… ëª©ë¡ìœ¼ë¡œ</a>
</div>

{% endblock %}
